# 数字乡村人才信息系统 - 测试套件

## 📋 概述

这是一个精简优化的测试套件，包含系统的核心功能测试。已清理所有重复和空文件，保留3个核心测试脚本，确保测试的完整性和可维护性。

## 🧪 核心测试脚本

### 1. `simple-verification.js` - 系统健康检查
- ✅ 检查服务端口状态 (8083后端, 8081前端)
- ✅ 验证数据库连接和表结构完整性
- ✅ 测试核心API端点可访问性
- ✅ 提供数据统计概览
- 🎯 **适用场景**: 快速系统状态验证、部署检查

### 2. `test_system_integration.js` - 系统集成测试
- ✅ 完整的用户注册和登录流程
- ✅ 人员信息CRUD操作验证
- ✅ 用户与人员信息关联测试
- ✅ 三级权限控制验证 (管理员/用户/访客)
- 🎯 **适用场景**: 完整业务流程验证

### 3. `test_dual_user_features.js` - 权限对比测试
- ✅ 管理员vs普通用户权限差异验证
- ✅ 数据访问权限测试 (登录用户看完整数据)
- ✅ 管理功能权限控制 (统计、删除等)
- ✅ 跨角色功能对比
- 🎯 **适用场景**: 权限控制系统验证

## 🚀 快速使用

### 推荐：使用自动化脚本
```bash
# 给脚本执行权限
chmod +x run-tests.sh

# 运行完整测试套件  
./run-tests.sh all

# 运行特定测试
./run-tests.sh health        # 系统健康检查
./run-tests.sh integration   # 系统集成测试  
./run-tests.sh permissions   # 权限功能测试
```

### 直接运行脚本
```bash
node simple-verification.js       # 健康检查
node test_system_integration.js   # 集成测试
node test_dual_user_features.js   # 权限测试
```

## ⚙️ 测试环境要求

- Node.js >= 20.0.0
- 后端服务运行在 http://localhost:8083
- 前端服务运行在 http://localhost:8081 (可选)
- SQLite数据库已初始化

## 🔐 权限控制测试说明

### 三级权限体系
1. **👑 管理员** (`admin`/`admin123`)
   - 完整数据访问权限
   - 系统统计和管理功能
   - 所有用户和人员信息管理

2. **👤 普通用户** (`testuser`/`test123`)  
   - 完整数据访问权限 (与管理员相同)
   - 只能编辑自己绑定的人员信息
   - 无系统管理功能权限

3. **👻 访客** (未登录)
   - 基础公开信息访问
   - 敏感信息脱敏显示 (手机号、邮箱等)
   - 无编辑权限

### 关键测试点
- ✅ **数据访问**: 登录用户都能看到完整信息
- ✅ **编辑权限**: 普通用户只能修改自己的资料
- ✅ **管理功能**: 只有管理员能访问统计等功能
- ✅ **访客保护**: 未登录时敏感信息脱敏

## 📊 测试详情

### 1. 系统健康检查 (`simple-verification.js`)
**目的**: 快速验证系统基础设施状态

**检查项目**:
- ✅ 服务端口监听状态 (8083后端, 8081前端)
- ✅ 数据库文件存在性和连接
- ✅ 数据表结构完整性验证
- ✅ 基础数据统计 (人员、用户、农村特色信息)
- ✅ 核心API端点可访问性测试

**输出示例**:
```
✅ 后端服务 (端口 8083) 正在运行
✅ 前端服务 (端口 8081) 正在运行
✅ 数据库文件存在
✅ 所有必需的数据表都存在
✅ 数据统计: 人员信息: 13 条, 用户账户: 17 条
```

### 2. 系统集成测试 (`test_system_integration.js`)
**目的**: 验证系统核心业务流程完整性

**测试流程**:
1. 🔐 用户注册和登录
2. 👤 用户信息获取和验证
3. 📝 人员信息创建和管理
4. 🔗 用户与人员信息关联
5. 👻 访客权限和数据脱敏验证
6. 🛡️ 权限控制和角色验证

**覆盖功能**:
- JWT认证流程
- RESTful API CRUD操作
- 数据关联和完整性
- 三级权限控制系统
### 3. 权限对比测试 (`test_dual_user_features.js`)
**目的**: 验证不同用户角色的权限差异和数据访问控制

**测试内容**:
- 👑 管理员权限功能验证
- 👤 普通用户权限限制测试
- 🔍 跨角色数据访问对比
- 🛡️ 角色特定API端点权限

**对比验证项目**:
- 用户档案获取 (应该有差异)
- 人员列表访问 (登录用户都看完整数据)
- 人员详情查看 (登录用户都看完整数据)
- 系统统计访问 (只有管理员可访问)

**输出示例**:
```
✅ 管理员登录成功
✅ 普通用户登录成功
📊 管理员: 获取13条记录，手机号完整
📊 普通用户: 获取13条记录，手机号完整
✅ 人员列表访问: 登录用户都能看到完整数据
✅ 系统统计访问: 权限控制正常
```

## 🔧 故障排除

### 常见问题

**Q: 测试失败，提示连接错误**
```
❌ 连接被拒绝 (后端服务未启动)
```
A: 确保后端服务正在运行：
```bash
cd /home/shardzzi/rural-talent-system
./start-all.sh
# 或者单独启动后端
cd backend && pnpm run dev
```

**Q: 权限测试失败，提示认证错误**
```
❌ 管理员登录失败: 401 Unauthorized
```
A: 检查测试账户是否存在：
- 管理员: `admin` / `admin123`
- 测试用户: `testuser` / `test123`

**Q: 数据库相关测试失败**
```
❌ 数据库文件不存在
```
A: 确认数据库文件路径：
```bash
ls -la /home/shardzzi/rural-talent-system/backend/data/persons.db
```

**Q: API测试返回403/404错误**
A: 故障排除步骤：
1. 确认后端服务正常启动 (端口8083)
2. 检查API路由配置和数据库连接
3. 查看后端日志: `tail -f logs/backend.log`

## 📈 测试套件优化历程

### v2.0 版本重大改进 (2025年6月)
- ✅ **大幅精简**: 删除了7个重复/空的测试文件
- ✅ **核心聚焦**: 保留3个核心测试脚本，覆盖全部功能
- ✅ **权限修正**: 修复权限控制逻辑不一致问题
- ✅ **输出优化**: 统一测试输出格式，提升可读性
- ✅ **依赖清理**: 移除重复的node_modules，使用根目录依赖

### 权限控制系统修复
在v2.0版本中，我们发现并修复了权限控制系统中的关键不一致问题：

**修复前的问题**:
- README.md描述普通用户看脱敏信息
- 后端代码逻辑普通用户看完整信息
- 测试期望与实际逻辑不符

**修复后的正确逻辑**:
- 👻 **访客**: 敏感信息脱敏 (手机号打码、地址隐藏等)
- 👤 **普通用户**: 完整信息访问，编辑权限受限
- 👑 **管理员**: 完整信息访问和管理权限

### 保留的核心测试
```
✅ simple-verification.js       (系统健康检查)
✅ test_system_integration.js   (完整集成测试)
✅ test_dual_user_features.js   (权限对比测试)
✅ run-tests.sh                 (自动化测试脚本)
✅ README.md                    (完整测试文档)
```

## 📝 维护说明

### 测试脚本特点
- 🚀 **轻量级**: 仅使用Node.js原生功能和axios库
- 📊 **详细输出**: 彩色控制台输出，清晰的测试结果
- 🔍 **错误定位**: 测试失败时显示具体错误信息和建议
- 🔄 **独立运行**: 支持单独运行或批量执行

### 添加新测试的建议
1. **扩展现有脚本**: 在现有3个核心脚本中添加相关功能
2. **避免重复**: 不要创建功能重复的新测试文件
3. **保持简洁**: 保持测试的可读性和可维护性
4. **更新文档**: 及时更新README.md说明

### 测试数据管理
- 测试使用独立的测试账户，不影响生产数据
- 清理脚本会自动清理测试过程中创建的临时数据
- 数据库使用SQLite，便于备份和恢复

## 🎯 最佳实践

### 运行测试前的检查清单
1. ✅ 后端服务已启动 (端口8083)
2. ✅ 数据库文件存在且可访问
3. ✅ 测试账户已创建 (admin/testuser)
4. ✅ 网络连接正常

### 测试结果解读
- **绿色** ✅: 测试通过，功能正常
- **黄色** ⚠️: 警告信息，需要关注但不影响功能
- **红色** ❌: 测试失败，需要立即处理
- **蓝色** ℹ️: 信息提示，正常的权限控制响应

---

**文档最后更新**: 2025年6月6日  
**测试套件版本**: v2.0  
**维护状态**: ✅ 活跃维护