# 技术架构文档

## 🏗️ 系统架构概览

数字乡村人才信息系统采用现代化的前后端分离架构，具有轻量化、易部署、本地化的特点。

### 架构图
```
┌─────────────────────────────────────────────────────────────┐
│                     用户界面层                                │
├─────────────────────────────────────────────────────────────┤
│  Vue 3 前端应用 (端口: 8081)                                  │
│  ├── 管理员仪表板    ├── 用户仪表板    ├── 访客视图            │
│  ├── Element Plus UI ├── TypeScript   ├── Pinia 状态管理     │
│  └── Vite 构建工具   └── Vue Router   └── Axios HTTP客户端   │
├─────────────────────────────────────────────────────────────┤
│                     网络通信层                                │
│  HTTP/HTTPS RESTful API + JWT 认证                          │
├─────────────────────────────────────────────────────────────┤
│  Node.js 后端服务 (端口: 8083)                               │
│  ├── Express.js 框架  ├── TypeScript     ├── JWT 认证       │
│  ├── MVC 架构模式      ├── 中间件系统     ├── 日志系统       │
│  └── SQLite 数据库     └── 错误处理      └── 数据验证       │
├─────────────────────────────────────────────────────────────┤
│                     数据存储层                                │
│  SQLite 数据库 (backend/data/persons.db)                    │
│  ├── users 用户表      ├── persons 人员表  ├── 关系约束     │
│  ├── 农村特色信息表     ├── 技能特长表      ├── 数据索引     │
│  └── 合作意向表        └── 审计日志        └── 备份机制     │
└─────────────────────────────────────────────────────────────┘
```

## 🛠️ 技术栈详解

### 前端技术栈
| 技术 | 版本 | 用途 | 优势 |
|------|------|------|------|
| **Vue 3** | 3.5.16 | 前端框架 | 组合式API、更好的TypeScript支持 |
| **TypeScript** | 5.8.3 | 类型系统 | 类型安全、更好的开发体验 |
| **Element Plus** | 2.9.11 | UI组件库 | 丰富的组件、Vue 3原生支持 |
| **Pinia** | 3.0.3 | 状态管理 | 更简单的API、TypeScript支持 |
| **Vue Router** | 4.5.1 | 路由管理 | 声明式路由、导航守卫 |
| **Vite** | 6.3.5 | 构建工具 | 极快的热重载、优秀的构建性能 |
| **Axios** | 1.9.0 | HTTP客户端 | 拦截器、请求/响应转换 |

### 后端技术栈
| 技术 | 版本 | 用途 | 优势 |
|------|------|------|------|
| **Node.js** | 20.x+ | 运行环境 | 高性能、非阻塞I/O |
| **Express.js** | 4.21.2 | Web框架 | 轻量级、中间件生态丰富 |
| **TypeScript** | 5.8.3 | 类型系统 | 类型安全、更好的维护性 |
| **SQLite** | 5.1.7 | 数据库 | 轻量级、无需配置、适合中小型应用 |
| **JWT** | 9.0.2 | 身份认证 | 无状态认证、跨域支持 |
| **Winston** | 3.17.0 | 日志系统 | 分级日志、多种输出格式 |
| **bcrypt** | 6.0.0 | 密码加密 | 安全的密码哈希算法 |

### 开发工具栈
| 工具 | 版本 | 用途 |
|------|------|------|
| **pnpm** | 8.15.0 | 包管理器 |
| **nodemon** | 3.1.10 | 开发热重载 |
| **ESLint** | 8.57.1 | 代码规范 |
| **ts-node** | 10.9.2 | TypeScript执行 |

## 📁 项目结构设计

### 前端架构 (frontend/)
```
frontend/
├── src/
│   ├── main.ts              # 应用入口点
│   ├── App.vue              # 根组件
│   ├── components/          # 可复用组件
│   │   ├── LoginForm.vue    # 登录表单组件
│   │   ├── PersonDetailDialog.vue  # 人员详情对话框
│   │   └── PersonFormDialog.vue    # 人员表单对话框
│   ├── views/               # 页面组件
│   │   ├── AdminDashboard.vue      # 管理员页面
│   │   ├── UserDashboard.vue       # 用户页面
│   │   └── GuestView.vue           # 访客页面
│   ├── stores/              # Pinia状态管理
│   │   └── auth.ts          # 认证状态
│   ├── api/                 # API接口层
│   │   └── persons.ts       # 人员信息API
│   └── router/              # 路由配置
│       └── index.ts         # 路由定义
├── vite.config.ts           # Vite构建配置
└── package.json             # 依赖和脚本配置
```

### 后端架构 (backend/)
```
backend/
├── src/
│   ├── app.ts               # 应用入口点
│   ├── controllers/         # 控制器层 (处理HTTP请求)
│   │   ├── authController.ts    # 认证控制器
│   │   └── personController.ts  # 人员信息控制器
│   ├── middleware/          # 中间件层
│   │   ├── auth.ts          # JWT认证中间件
│   │   ├── errorHandler.ts  # 全局错误处理
│   │   └── validation.ts    # 数据验证中间件
│   ├── routes/              # 路由层
│   │   ├── authRoutes.ts    # 认证路由
│   │   └── personRoutes.ts  # 人员信息路由
│   ├── services/            # 服务层 (业务逻辑)
│   │   └── databaseService.ts   # 数据库服务
│   ├── config/              # 配置层
│   │   └── logger.ts        # 日志配置
│   └── types/               # 类型定义
│       └── index.ts         # 通用类型
├── data/                    # 数据存储
│   └── persons.db           # SQLite数据库
└── package.json             # 依赖和脚本配置
```

## 🔄 数据流设计

### 1. 认证流程
```
用户登录 → 前端验证 → 后端验证 → JWT生成 → 前端存储 → 后续请求携带
```

### 2. 数据查询流程
```
前端请求 → 路由匹配 → 认证中间件 → 控制器 → 服务层 → 数据库 → 响应返回
```

### 3. 权限控制流程
```
请求 → JWT验证 → 角色检查 → 资源权限验证 → 数据脱敏 → 响应
```

## 🔐 安全架构

### 认证机制
- **JWT Token**: 无状态认证，包含用户ID和角色信息
- **密码加密**: 使用bcrypt进行密码哈希存储
- **会话管理**: 前端Pinia状态管理，支持自动登出

### 权限控制
```typescript
// 三级权限体系
enum UserRole {
  GUEST = 'guest',     // 访客：只能查看脱敏信息
  USER = 'user',       // 用户：查看完整信息，编辑自己的数据
  ADMIN = 'admin'      // 管理员：完全访问权限
}
```

### 数据保护
- **敏感信息脱敏**: 访客无法查看手机号、身份证等
- **输入验证**: 使用express-validator进行数据验证
- **SQL注入防护**: 使用参数化查询

## 📊 性能优化 (v2.2.1)

### 前端优化
- **代码分割**: 主包体积减少98% (1.17MB → 22.7KB)
- **按需加载**: Element Plus组件按需导入，减少51%体积
- **缓存策略**: 静态资源长期缓存，业务代码短期缓存
- **gzip压缩**: 静态资源压缩率提升52%

### 后端优化
- **数据库索引**: 关键字段建立索引提升查询性能
- **连接池**: SQLite连接复用
- **日志分级**: 生产环境只记录必要日志
- **响应压缩**: gzip压缩API响应

## 🚀 部署架构

### 开发环境
```bash
# 并行启动开发服务
pnpm dev
# 前端: http://localhost:8081 (Vite热重载)
# 后端: http://localhost:8083 (nodemon自动重启)
```

### 生产环境
```bash
# 构建和启动生产服务
pnpm build && pnpm start
# 前端: 静态文件服务
# 后端: Node.js生产模式
```

### 容器化部署 (可选)
```dockerfile
# 多阶段构建
FROM node:20-alpine AS builder
# ... 构建阶段

FROM node:20-alpine AS runtime
# ... 运行阶段
```

## 🔧 扩展性设计

### 水平扩展
- **数据库**: SQLite → PostgreSQL/MySQL (大规模部署)
- **缓存**: 可添加Redis缓存层
- **负载均衡**: 支持多实例部署

### 功能扩展
- **文件上传**: 支持头像、证书等文件
- **消息队列**: 添加异步任务处理
- **微服务**: 按业务模块拆分服务

## 📈 监控与维护

### 日志系统
- **分级日志**: error、warn、info、debug
- **日志轮转**: 按大小和时间自动轮转
- **集中收集**: 支持ELK Stack集成

### 健康检查
- **端点监控**: `/api/health` 健康检查端点
- **数据库连接**: 定期检查数据库状态
- **自动化测试**: 完整的测试套件保障

## 📖 相关文档

- [pnpm 使用指南](PNPM_GUIDE.md) - 包管理器详细说明
- [测试指南](TESTING_GUIDE.md) - 测试系统说明
- [启动指南](STARTUP_GUIDE.md) - 项目启动说明
- [贡献指南](CONTRIBUTING.md) - 开发贡献流程

---

**架构版本**: v2.2.1  
**更新时间**: 2025年6月6日  
**技术栈状态**: 生产就绪
